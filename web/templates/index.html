{% extends "base.html" %} {% block navbutton %}

<a href="{{ url_for('logout') }}" class="btn btn-info my-2 my-sm-0">Log Out</a>

{% endblock %} {% block content %}
<!-- Compiled and minified CSS Materialize Used for the Date Picker -->
<!-- 
<link
  rel="stylesheet"
  href="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/4.1.3/css/bootstrap.css"
/> -->
<link
  rel="stylesheet"
  href="https://cdn.datatables.net/1.10.20/css/dataTables.bootstrap4.min.css"
/>
<link
  rel="stylesheet"
  href="https://cdnjs.cloudflare.com/ajax/libs/materialize/1.0.0/css/materialize.min.css"
/>
<style>
  .modal {
    /* Override Boostrap options for Materialize CSS to work */
    height: auto;
  }

  nav {
    /* Override Materialize CSS options for Bootstrap to work*/
    color: #111011;
    height: auto;
    line-height: normal;
  }

  .empty-table {
    display: grid;
    height: 80vh;
    justify-content: center;
    align-items: center;
    text-align: center;
  }

  .empty-table-child {
    display: grid;
    justify-content: center;
    align-items: center;
    text-align: center;
  }
  label {
    color: black;
    font-size: 16px;
  }
  .dataTables_wrapper {
    font-size: 15px;
  }
  .table th {
    background-color: #eb5757;
    color: white;
  }
  .page-link {
    size: 10px;
  }
  a { color: inherit; } 
  .pagination li a{
    font-size: 12px;
  }
  .page-item.active .page-link{
    background-color: grey;
  }
 .table-icon{
   font-size: 10px;
 }
 .btn{
  background-color: #2d9cdb
 }


</style>
<!-- Table skeleton  -->
<div class="container-md">
  {% if connections|length > 0 %}
  <div class="table-responsive">
    <table class="table table-hover connections-table">
      <thead>
        <tr>
          <th></th>
          <th></th>
          <th>Name</th>
          <th>Title</th>
          <th>Email</th>
          <th>Phone</th>
          <th>Last Contacted</th>
          <th>Contact By</th>
          <th>Tags</th>
          <th>Note</th>
        </tr>
      </thead>
      <tbody>
        {% for connection in connections %}
        <tr id="{{ connection.id }}">
            <td><a href="#edit-modal" class = "connection-edit modal-trigger"><span class="fa fa-edit table-icon"></span></a></td>
          <!-- Modal trigger for delete popup warning message-->
            <td><a class="modal-trigger" href="#warning-modal"><span class="fa fa-trash table-icon" id="delete" value= "{{connection}}"></span></a></td>
          <td>{{ connection.name }}</td>
          <td>{{ connection.title }}</td>
          <td>{{ connection.email }}</td>
          <td>{{ connection.phone }}</td>
          <td>{{ connection.last_contacted }}</td>
          <td>{{ connection.contact_by }}</td>
          <td>{{ connection.tags }}</td>
          <td>{{ connection.note }}</td>
        </tr>

         <!-- Modal Structure for delete popup warning message-->
        <div id="warning-modal" class="modal">
          <div class="modal-content">
            <h4>Are you sure?</h4>
            <p>This row will be permanently deleted from your connections table. This cannot be undone.</p>
          </div>
          <div class="modal-footer">
            <a href="" class="modal-close waves-effect waves-green btn-flat">Cancel</a>
            <a href="/delete/{{connection.id}}" class="modal-close waves-effect waves-light btn-flat red">Delete</a>
          </div>
        </div>

        {% endfor %}
      </tbody>
    </table>
  </div>
  {% else %}
  <div class="empty-table">
    <div class="empty-table-child">
      <i class="large material-icons-two-tone">face</i>
      <p class="flow-text">There are no connections here yet ...</p>
    </div>
  </div>
  {% endif %}
  
 

  <!-- Tap Target Structure -->
  <div
    id="add-connection-tap-target"
    class="tap-target light-blue accent-3"
    data-target="add-connection-btn"
  >
    <div class="tap-target-content">
      <h5>Add a connection</h5>
      <p class="text-body">
        Click to add a connection that you care about. We will make sure to help
        follow up with them.
      </p>
    </div>
  </div>

  <!-- Modal Trigger -->
  <div
    class="fixed-action-btn tooltipped"
    data-position="left"
    data-tooltip="Add a connection"
  >
    <a
      id="add-connection-btn"
      class="btn-floating btn-large red modal-trigger light-blue accent-3"
      href="#connection-modal"
    >
      <i class="large material-icons">add</i>
    </a>
  </div>

  <!-- Modal Structure to add a new connection -->
  <div id="connection-modal" class="modal">
    <div class="modal-content">
      <form
        id="connection-form"
        class="col s12"
        action="{{ url_for('add_connection') }}"
        method="POST"
      >
        {{ form.hidden_tag() }}
        <h2>Add a Connection</h2>
        <div class="row">
          <div class="input-field col s6">
            <i class="material-icons prefix">person</i>
            {{ form.title(size=32, class="validate") }} {{ form.title.label(class="active") }}
          </div>
          <div class="input-field col s6">
            <i class="material-icons prefix">person</i>
            {{ form.name(size=32, class="validate") }} {{ form.name.label(class="active") }}
          </div>
        </div>
        <div class="row">
          <div class="input-field col s6">
            <i class="material-icons prefix">email</i>
            {{ form.email(size=32, class="validate") }} {{ form.email.label(class="active")}}
          </div>
          <div class="input-field col s6">
            <i class="material-icons prefix">phone</i>
            {{ form.phone(size=32, class="validate") }} {{ form.phone.label(class="active")}}
          </div>
        </div>
        <div class="row">
          <div class="input-field col s6">
            <i class="material-icons prefix">date_range</i>
            {{ form.last_contacted(size=32, placeholder="yyyy-mm-dd",
            class="datepicker validate") }} {{ form.last_contacted.label }}
          </div>
          <div class="input-field col s6">
            <i class="material-icons prefix">date_range</i>
            {{ form.contact_by(size=32, placeholder="yyyy-mm-dd",
            class="datepicker validate") }} {{ form.contact_by.label }}
          </div>
        </div>

        <div class="row">
          <div class="input-field col s12">
            <i class="material-icons prefix">label</i>
            <div id="tags-chips" class="chips"></div>
          </div>
        </div>

        <div class="row">
          <div class="input-field col s12">
            <i class="material-icons prefix">description</i>
            {{ form.note(size=64, class="materialize-textarea") }} {{
            form.note.label }}
          </div>
        </div>
        <div class="row">
          <div class="input-field col s12">
            {{ form.submit(class="btn btn-primary") }}
          </div>
        </div>
        {% with messages = get_flashed_messages() %} {% if messages %}
        <ul>
          {% for message in messages %}
          <li>{{ message }}</li>
          {% endfor %}
        </ul>
        {% endif %} {% endwith %}
      </form>
    </div>
  </div>
</div>


  <!-- Modal Structure to edit connection -->
  <div id="edit-modal" class="modal">
    <div class="modal-content">
      <form
        id="edit-form"
        class="col s12"
        action="{{ url_for('edit_connection', connection_id = 1) }}"
        method="POST"
      >
        {{ form.hidden_tag() }}
        <h2>Add a Connection</h2>
        <div class="row">
          <div class="input-field col s6">
            <i class="material-icons prefix">person</i>
            {{ form.title(size=32, class="validate") }} {{ form.title.label(class="active") }}
          </div>
          <div class="input-field col s6">
            <i class="material-icons prefix">person</i>
            {{ form.name(size=32, class="validate") }} {{ form.name.label(class="active") }}
          </div>
        </div>
        <div class="row">
          <div class="input-field col s6">
            <i class="material-icons prefix">email</i>
            {{ form.email(size=32, class="validate") }} {{ form.email.label(class="active")}}
          </div>
          <div class="input-field col s6">
            <i class="material-icons prefix">phone</i>
            {{ form.phone(size=32, class="validate") }} {{ form.phone.label(class="active")}}
          </div>
        </div>
        <div class="row">
          <div class="input-field col s6">
            <i class="material-icons prefix">date_range</i>
            {{ form.last_contacted(size=32, placeholder="yyyy-mm-dd",
            class="datepicker validate") }} {{ form.last_contacted.label }}
          </div>
          <div class="input-field col s6">
            <i class="material-icons prefix">date_range</i>
            {{ form.contact_by(size=32, placeholder="yyyy-mm-dd",
            class="datepicker validate") }} {{ form.contact_by.label }}
          </div>
        </div>

        <div class="row">
          <div class="input-field col s12">
            <i class="material-icons prefix">label</i>
            <div id="tags-chips" class="chips"></div>
          </div>
        </div>

        <div class="row">
          <div class="input-field col s12">
            <i class="material-icons prefix">description</i>
            {{ form.note(size=64, class="materialize-textarea") }} {{
            form.note.label }}
          </div>
        </div>
        <div class="row">
          <div class="input-field col s12">
            {{ form.submit(class="btn btn-primary") }}
          </div>
        </div>
        {% with messages = get_flashed_messages() %} {% if messages %}
        <ul>
          {% for message in messages %}
          <li>{{ message }}</li>
          {% endfor %}
        </ul>
        {% endif %} {% endwith %}
      </form>
    </div>
  </div>
</div>
<!-- end modal structure for edit  -->

<!-- Compiled and minified JavaScript Materialize -->

<script src="https://code.jquery.com/jquery-3.3.1.js"></script>
<script src="https://cdn.datatables.net/1.10.20/js/jquery.dataTables.min.js"></script>
<script src="https://cdn.datatables.net/1.10.20/js/dataTables.bootstrap4.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/materialize/1.0.0/js/materialize.min.js"></script>

<script>
  $(".connections-table").DataTable({
    fixedHeader: true,
    order: [[2, "asc"]],
    info: false,
    ordering: true,
    lengthChange: false,
    pageLength: 10,
    columnDefs: [
      {
        targets: 0,
        orderable: false,
      },
        {
        targets: 1,
        orderable: false,
      },
    ],
  });
  document.addEventListener("DOMContentLoaded", function () {
    const datePickerElems = document.querySelectorAll(".datepicker");
    const datePickerOptions = {
      container: document.getElementsByTagName("body"),
      format: "yyyy-mm-dd",
    };
    const datePickerInstances = M.Datepicker.init(
      datePickerElems,
      datePickerOptions
    );

    const chipElems = document.querySelectorAll(".chips");
    const chipOptions = {
      placeholder: "Tags",
      secondaryPlaceholder: "+ Add a tag",
    };
    const chipInstances = M.Chips.init(chipElems, chipOptions);

    const modalElems = document.querySelectorAll(".modal");
    const modalInstances = M.Modal.init(modalElems);
    const connectionModal = document.getElementById('connection-modal');
    const connectionModalInstance = M.Modal.getInstance(connectionModal);

    const toolTipElems = document.querySelectorAll(".tooltipped");
    const toolTipInstances = M.Tooltip.init(toolTipElems);

    const tapTargetElems = document.querySelectorAll(".tap-target");
    const tapTargetInstances = M.TapTarget.init(tapTargetElems);

    const addConnectionTapTargetInstance = M.TapTarget.getInstance(
      document.getElementById("add-connection-tap-target")
    );

    let connectionsCount = "{{ connections | length }}";
    if (connectionsCount < 1) {
      setTimeout(() => {
        addConnectionTapTargetInstance.open();
      }, 1000);
    }

    const formElem = document.getElementById("connection-form");
    formElem.addEventListener("submit", (e) => {
      e.preventDefault();
      e.stopPropagation();

    

      const tagsChipsElem = document.getElementById("tags-chips");
      const tagsChipsInstance = M.Chips.getInstance(tagsChipsElem);
      const tagData = tagsChipsInstance.chipsData.reduce(
        (accumulator, current_value, i, array) => {
          accumulator += current_value.tag;
          if (i !== array.length - 1) {
            accumulator += ", ";
          }
          return accumulator;
        },
        ""
      );

      const tagsElem = document.getElementById("tags");
      tagsElem.value = tagData;
      fetch(formElem.action, {
        method: "POST",
        body: new URLSearchParams(new FormData(formElem)),
      }).then((res) => {
        console.log(res);
        formElem.reset();
        M.Chips.init(chipElems, chipOptions);
        const addConnectionModalForm = M.Modal.getInstance(
          document.getElementById("connection-modal")
        );
        addConnectionModalForm.close();
        if (res.redirected) {
          window.location.href = res.url;
        }
      });
      return true;
    });

    // function that converts date to the appropriate format (yyyy-MM-dd)
    function formatDate(date) {
    var d = new Date(date),
        month = '' + (d.getMonth() + 1),
        day = '' + d.getDate(),
        year = d.getFullYear();

    if (month.length < 2) month = '0' + month;
    if (day.length < 2) day = '0' + day;

    return [year, month, day].join('-');
} 
    const editButtonElems = document.querySelectorAll('.connection-edit');
    editButtonElems.forEach((editButtonElem) => {
      editButtonElem.addEventListener('click', ()=>{
        const connection_id = editButtonElem.parentNode.parentNode.id;
        fetch(`/edit_connection/${connection_id}`)
          .then(response => response.json())
          .then(data => {
            connectionModal.querySelector('#title').value=data['title']
            connectionModal.querySelector('#name').value=data['name']
            connectionModal.querySelector('#email').value=data['email']
            connectionModal.querySelector('#phone').value=data['phone']
            connectionModal.querySelector('#contact_by').value=formatDate(data['contact_by']) // the dates
            connectionModal.querySelector('#tags').value=data['tags'] // figure out this one 
            connectionModal.querySelector('#last_contacted').value=formatDate(data['last_contacted']) // The dates
            connectionModal.querySelector('#note').value=data['note']
            M.updateTextFields();
            connectionModalInstance.open();
            // and something in between
          });
      });
    });
  });
</script>
{% endblock %}
